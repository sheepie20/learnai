<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7182226546993141"
     crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LearnAI Chat</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon-96x96.png">
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <meta name="theme-color" content="#3498db">
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true
      },
      svg: { fontCache: 'global' },
      options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/highlight.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; margin: 0; padding: 0; background-color: #f5f5f5; display: flex; }
    .sidenav { width: 250px; height: 100vh; background-color: #2c3e50; padding-top: 20px; position: fixed; left: 0; top: 0; color: white; }
    .sidenav .logo { padding: 20px; font-size: 1.5em; font-weight: bold; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .sidenav .nav-links { list-style: none; padding: 0; margin: 0; }
    .sidenav .nav-links li { padding: 0; margin: 0; }
    .sidenav .nav-links a { color: white; text-decoration: none; padding: 15px 20px; display: block; transition: background-color 0.3s; font-size: 16px; }
    .sidenav .nav-links a:hover { background-color: #34495e; }
    .sidenav .nav-links a.active { background-color: #3498db; }
    .sidenav .nav-links i { margin-right: 10px; }
    .main-content { flex: 1; margin-left: 250px; padding: 20px; min-height: 100vh; box-sizing: border-box; width: calc(100% - 250px); }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
    .chat-container { max-height: 60vh; overflow-y: auto; margin-bottom: 20px; background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #eee; }
    .message { margin-bottom: 18px; display: flex; }
    .message.user { justify-content: flex-end; }
    .message.assistant { justify-content: flex-start; }
    .bubble { max-width: 70%; padding: 14px 18px; border-radius: 18px; font-size: 16px; line-height: 1.5; }
    .message.user .bubble { background: #3498db; color: white; border-bottom-right-radius: 4px; }
    .message.assistant .bubble { background: #e9ecef; color: #2c3e50; border-bottom-left-radius: 4px; }
    .chat-input-row { display: flex; gap: 10px; }
    #chatInput { flex: 1; padding: 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
    #sendBtn { padding: 12px 24px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
    #sendBtn:hover { background-color: #2980b9; }
    .loading-indicator { text-align: center; color: #888; font-style: italic; margin: 10px 0; }
  </style>
</head>
<body>
  <nav class="sidenav">
    <div class="logo">LearnAI</div>
    <ul class="nav-links">
      <li><a href="/" title="Home">üè† Home</a></li>
      <li><a href="#" onclick="navigateToDashboards(event)" title="My Dashboards">üìö My Dashboards</a></li>
      <li><a href="#" onclick="navigateToDashboard(event)" title="Dashboard">üìä Dashboard</a></li>
      <li><a href="/quiz/{{ quiz_id }}" title="Take Quiz">‚úçÔ∏è Take Quiz</a></li>
      <li><a href="/chat/{{ quiz_id }}" class="active" title="AI Chat">ü§ñ AI Chat</a></li>
      <li><a href="#" onclick="navigateToProfile(event)" title="Profile">üë§ Profile</a></li>
    </ul>

<!-- chatbot_2 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-7182226546993141"
     data-ad-slot="4467800954"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!-- chatbot_1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-7182226546993141"
     data-ad-slot="3533993233"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </nav>
  <div class="main-content">
    <div class="container">
      <h1>AI Study Chat</h1>
      <div id="chatContainer" class="chat-container"></div>
      <div class="chat-input-row">
        <input id="chatInput" type="text" placeholder="Ask a question about your notes..." autocomplete="off" />
        <button id="sendBtn">Send</button>
      </div>
      <div style="text-align:right;margin-top:10px;">
        <button id="deleteChatBtn" style="background:#e74c3c;color:white;border:none;border-radius:5px;padding:10px 18px;cursor:pointer;">Delete Chat</button>
      </div>
      <div id="chatLoading" class="loading-indicator" style="display:none;">Thinking...</div>
    </div>
  </div>
  <script>
    const quizId = window.location.pathname.split('/').pop();
    // Load chat history from localStorage if available
    let chatHistory = [];
    const chatKey = `chat_history_${quizId}`;
    if (localStorage.getItem(chatKey)) {
      try {
        chatHistory = JSON.parse(localStorage.getItem(chatKey));
      } catch (e) {
        chatHistory = [];
      }
    }
    function saveChatHistory() {
      localStorage.setItem(chatKey, JSON.stringify(chatHistory));
    }
    function renderChat() {
      const container = document.getElementById('chatContainer');
      container.innerHTML = '';
      chatHistory.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message ' + msg.role;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = marked.parse(msg.content);
        // Render LaTeX using MathJax after inserting the message
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
          MathJax.typesetPromise([bubble]);
        }
        div.appendChild(bubble);
        container.appendChild(div);
      });
      // Highlight code blocks
      if (typeof hljs !== 'undefined') {
        container.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      }
      // MathJax typeset for the whole container (fallback)
      if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
        MathJax.typesetPromise([container]);
      }
      container.scrollTop = container.scrollHeight;
    }
    // Remove and re-add event listeners to prevent duplicate bindings
    function setupChatEventListeners() {
      const sendBtn = document.getElementById('sendBtn');
      const chatInput = document.getElementById('chatInput');
      const deleteBtn = document.getElementById('deleteChatBtn');
      sendBtn.onclick = sendMessage;
      chatInput.onkeydown = function(e) {
        if (e.key === 'Enter') sendMessage();
      };
      deleteBtn.onclick = function() {
        if (confirm('Are you sure you want to delete this chat history? This cannot be undone.')) {
          chatHistory = [];
          saveChatHistory();
          renderChat();
        }
      };
    }
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      chatHistory.push({ role: 'user', content: text });
      saveChatHistory();
      renderChat();
      input.value = '';
      document.getElementById('chatLoading').style.display = 'block';
      try {
        const response = await fetch(`/api/chat/${quizId}` , {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: text, history: chatHistory })
        });
        if (!response.ok) throw new Error('Failed to get response');
        const data = await response.json();
        chatHistory.push({ role: 'assistant', content: data.answer });
        saveChatHistory();
        renderChat();
      } catch (e) {
        chatHistory.push({ role: 'assistant', content: '<span style="color:red">Error: Could not get a response.</span>' });
        saveChatHistory();
        renderChat();
      } finally {
        document.getElementById('chatLoading').style.display = 'none';
      }
    }
    // Navigation functions (copied from quiz.html)
    function navigateToDashboards(event) {
      event.preventDefault();
      let token = localStorage.getItem('access_token') || sessionStorage.getItem('dashboard_token');
      if (!token) { window.location.href = '/login'; return; }
      const form = document.createElement('form');
      form.method = 'POST'; form.action = '/dashboards'; form.style.display = 'none';
      const tokenField = document.createElement('input');
      tokenField.type = 'hidden'; tokenField.name = 'token'; tokenField.value = token;
      form.appendChild(tokenField); document.body.appendChild(form); form.submit();
    }
    function navigateToDashboard(event) {
      event.preventDefault();
      let token = localStorage.getItem('access_token') || sessionStorage.getItem('dashboard_token');
      if (!token) { window.location.href = '/login'; return; }
      const form = document.createElement('form');
      form.method = 'POST'; form.action = `/dashboard/${quizId}`; form.style.display = 'none';
      const tokenField = document.createElement('input');
      tokenField.type = 'hidden'; tokenField.name = 'token'; tokenField.value = token;
      form.appendChild(tokenField); document.body.appendChild(form); form.submit();
    }
    function navigateToProfile(event) {
      event.preventDefault();
      let token = localStorage.getItem('access_token') || sessionStorage.getItem('dashboard_token');
      if (!token) { window.location.href = '/login'; return; }
      const form = document.createElement('form');
      form.method = 'POST'; form.action = '/profile'; form.style.display = 'none';
      const tokenField = document.createElement('input');
      tokenField.type = 'hidden'; tokenField.name = 'token'; tokenField.value = token;
      form.appendChild(tokenField); document.body.appendChild(form); form.submit();
    }
    // On page load, render chat and set up listeners
    renderChat();
    setupChatEventListeners();
  </script>
</body>
</html>
